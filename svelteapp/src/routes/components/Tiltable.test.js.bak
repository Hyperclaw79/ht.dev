/**
 * @jest-environment jsdom
 */
import { render, fireEvent } from '@testing-library/svelte';
import Tiltable from './Tiltable.svelte';

describe('Tiltable component', () => {
    it('renders without crashing', () => {
        const { container } = render(Tiltable);
        expect(container).toBeTruthy();
    });

    it('has the correct CSS classes', () => {
        const { container } = render(Tiltable);
        
        const tiltingCard = container.querySelector('.tilting-card-content');
        expect(tiltingCard).toBeInTheDocument();
        
        const mouseTracker = container.querySelector('.mouse-position-tracker');
        expect(mouseTracker).toBeInTheDocument();
    });

    it('creates 9 tracker divs', () => {
        const { container } = render(Tiltable);
        
        const trackers = container.querySelectorAll('.tracker');
        expect(trackers).toHaveLength(9);
    });

    it('has proper accessibility attributes', () => {
        const { container } = render(Tiltable);
        
        const tiltingCard = container.querySelector('.tilting-card-content');
        expect(tiltingCard).toHaveAttribute('role', 'button');
        expect(tiltingCard).toHaveAttribute('tabindex', '0');
    });

    it('handles click events without errors', () => {
        // Mock document.elementsFromPoint to avoid errors
        global.document.elementsFromPoint = global.document.elementsFromPoint || (() => []);

        const { container } = render(Tiltable);
        const tiltingCard = container.querySelector('.tilting-card-content');
        
        // This should not throw an error
        expect(() => {
            fireEvent.click(tiltingCard, { x: 100, y: 100 });
        }).not.toThrow();
    });

    it('filters out tilting card elements from click targets', () => {
        const mockButton = { 
            tagName: 'BUTTON', 
            click: global.() => {},
            classList: { contains: () => false }
        };
        const mockTiltingElement = { 
            tagName: 'DIV',
            classList: { contains: (className) => className === 'tilting-card-content' }
        };
        
        global.document.elementsFromPoint = global.jest.fn(() => [
            mockTiltingElement,
            mockButton
        ]);

        const { container } = render(Tiltable);
        const tiltingCard = container.querySelector('.tilting-card-content');
        
        fireEvent.click(tiltingCard, { x: 100, y: 100 });
        
        expect(mockButton.click).toHaveBeenCalled();
    });

    it('filters out mouse-position-tracker elements from click targets', () => {
        const mockInput = { 
            tagName: 'INPUT', 
            click: () => {},
            classList: { contains: () => false }
        };
        const mockTracker = { 
            tagName: 'DIV',
            classList: { contains: (className) => className === 'mouse-position-tracker' }
        };
        
        global.document.elementsFromPoint = jest.fn(() => [
            mockTracker,
            mockInput
        ]);

        const { container } = render(Tiltable);
        const tiltingCard = container.querySelector('.tilting-card-content');
        
        fireEvent.click(tiltingCard, { x: 100, y: 100 });
        
        expect(mockInput.click).toHaveBeenCalled();
    });

    it('filters out tracker elements from click targets', () => {
        const mockAnchor = { 
            tagName: 'A', 
            click: () => {},
            classList: { contains: () => false }
        };
        const mockTrackerElement = { 
            tagName: 'DIV',
            classList: { contains: (className) => className === 'tracker' }
        };
        
        global.document.elementsFromPoint = jest.fn(() => [
            mockTrackerElement,
            mockAnchor
        ]);

        const { container } = render(Tiltable);
        const tiltingCard = container.querySelector('.tilting-card-content');
        
        fireEvent.click(tiltingCard, { x: 100, y: 100 });
        
        expect(mockAnchor.click).toHaveBeenCalled();
    });

    it('prioritizes interactive elements in sorting', () => {
        const mockDiv = { 
            tagName: 'DIV', 
            click: () => {},
            classList: { contains: () => false }
        };
        const mockButton = { 
            tagName: 'BUTTON', 
            click: () => {},
            classList: { contains: () => false }
        };
        
        global.document.elementsFromPoint = jest.fn(() => [
            mockDiv,
            mockButton
        ]);

        const { container } = render(Tiltable);
        const tiltingCard = container.querySelector('.tilting-card-content');
        
        fireEvent.click(tiltingCard, { x: 100, y: 100 });
        
        // Button should be clicked instead of div due to sorting
        expect(mockButton.click).toHaveBeenCalled();
        expect(mockDiv.click).not.toHaveBeenCalled();
    });

    it('handles elements that throw errors on click', () => {
        const mockElement = { 
            tagName: 'BUTTON', 
            click: jest.fn(() => { throw new Error('Click error'); }),
            classList: { contains: () => false }
        };
        
        global.document.elementsFromPoint = jest.fn(() => [mockElement]);

        const { container } = render(Tiltable);
        const tiltingCard = container.querySelector('.tilting-card-content');
        
        // Should not throw despite the element's click method throwing
        expect(() => {
            fireEvent.click(tiltingCard, { x: 100, y: 100 });
        }).not.toThrow();
        
        expect(mockElement.click).toHaveBeenCalled();
    });

    it('handles empty elements array from elementsFromPoint', () => {
        global.document.elementsFromPoint = jest.fn(() => []);

        const { container } = render(Tiltable);
        const tiltingCard = container.querySelector('.tilting-card-content');
        
        expect(() => {
            fireEvent.click(tiltingCard, { x: 100, y: 100 });
        }).not.toThrow();
    });

    it('handles only filtered elements (all elements removed)', () => {
        const mockTiltingElement = { 
            tagName: 'DIV',
            classList: { contains: (className) => className === 'tilting-card-content' }
        };
        const mockTrackerElement = { 
            tagName: 'DIV',
            classList: { contains: (className) => className === 'tracker' }
        };
        
        global.document.elementsFromPoint = jest.fn(() => [
            mockTiltingElement,
            mockTrackerElement
        ]);

        const { container } = render(Tiltable);
        const tiltingCard = container.querySelector('.tilting-card-content');
        
        expect(() => {
            fireEvent.click(tiltingCard, { x: 100, y: 100 });
        }).not.toThrow();
    });

    it('sorts anchor elements correctly', () => {
        const mockSpan = { 
            tagName: 'SPAN', 
            click: () => {},
            classList: { contains: () => false }
        };
        const mockAnchor = { 
            tagName: 'A', 
            click: () => {},
            classList: { contains: () => false }
        };
        
        global.document.elementsFromPoint = jest.fn(() => [
            mockSpan,
            mockAnchor
        ]);

        const { container } = render(Tiltable);
        const tiltingCard = container.querySelector('.tilting-card-content');
        
        fireEvent.click(tiltingCard, { x: 100, y: 100 });
        
        expect(mockAnchor.click).toHaveBeenCalled();
        expect(mockSpan.click).not.toHaveBeenCalled();
    });

    it('sorts input elements correctly', () => {
        const mockP = { 
            tagName: 'P', 
            click: () => {},
            classList: { contains: () => false }
        };
        const mockInput = { 
            tagName: 'INPUT', 
            click: () => {},
            classList: { contains: () => false }
        };
        
        global.document.elementsFromPoint = jest.fn(() => [
            mockP,
            mockInput
        ]);

        const { container } = render(Tiltable);
        const tiltingCard = container.querySelector('.tilting-card-content');
        
        fireEvent.click(tiltingCard, { x: 100, y: 100 });
        
        expect(mockInput.click).toHaveBeenCalled();
        expect(mockP.click).not.toHaveBeenCalled();
    });

    it('handles elements with missing click method gracefully', () => {
        const mockElement = { 
            tagName: 'BUTTON',
            classList: { contains: () => false }
            // No click method
        };
        
        global.document.elementsFromPoint = () => [mockElement];

        const { container } = render(Tiltable);
        const tiltingCard = container.querySelector('.tilting-card-content');
        
        expect(() => {
            fireEvent.click(tiltingCard, { x: 100, y: 100 });
        }).not.toThrow();
    });
});